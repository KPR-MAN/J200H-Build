name: Build J200H ROM (Fast)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: ubuntu:18.04  # <--- This runs old software on the new fast runner!

    steps:
    - name: 1. Prepare Cloud Computer
      uses: actions/checkout@v2

    - name: 2. Install Tools (Ubuntu 18.04 Style)
      run: |
        apt-get update
        apt-get install -y bc build-essential zip curl libstdc++6 git wget python gcc clang libssl-dev repo rsync flex bison openjdk-8-jdk sudo
        # Fix java location
        update-alternatives --set java /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java

    - name: 3. Initialize Source
      run: |
        mkdir -p ~/android
        cd ~/android
        git config --global user.name "CI"
        git config --global user.email "ci@ci.com"
        # Using older repo tool for older android
        curl https://storage.googleapis.com/git-repo-downloads/repo > /usr/bin/repo
        chmod a+x /usr/bin/repo
        
        repo init -u https://github.com/LineageOS/android.git -b cm-14.1 --depth=1

    - name: 4. Download Device Files
      run: |
        cd ~/android
        mkdir -p .repo/local_manifests
        # Copy the xml file from the repo to the container
        cp $GITHUB_WORKSPACE/.repo/local_manifests/roomservice.xml .repo/local_manifests/
        
        # Sync
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

    - name: 5. Start Building
      run: |
        cd ~/android
        . build/envsetup.sh
        
        # Select Device
        lunch lineage_j23g-userdebug
        
        # Build
        mka bacon

    - name: 6. Upload the Result
      uses: actions/upload-artifact@v2
      if: success()
      with:
        name: MY_J200H_ROM
        path: ~/android/out/target/product/j23g/*.zip
