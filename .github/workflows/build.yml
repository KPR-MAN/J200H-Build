name: J200H Build (Add SCX30G2 Common)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 1. SUPER CLEAN DISK
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        docker image prune --all --force

    - name: 2. Run Build Inside Docker
      run: |
        docker run --rm -i -v "$GITHUB_WORKSPACE:/root/android" ubuntu:18.04 /bin/bash -c "
        
        # --- INSIDE DOCKER START ---
        
        # 1. Install Tools
        apt-get update
        apt-get install -y git-core gnupg flex bison gperf build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip python python3 openjdk-8-jdk sudo rsync schedtool
        
        # 2. Fix Java
        update-alternatives --set java /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java

        # 3. Setup Repo
        curl https://storage.googleapis.com/git-repo-downloads/repo > /usr/bin/repo
        chmod a+x /usr/bin/repo

        # 4. Setup Workspace
        cd /root/android
        git config --global user.name 'CI'
        git config --global user.email 'ci@ci.com'

        repo init -u https://github.com/LineageOS/android.git -b cm-14.1 --depth=1
        
        # 5. Create Manifest
        mkdir -p .repo/local_manifests
        echo '<?xml version=\"1.0\" encoding=\"UTF-8\"?>
        <manifest>
          <!-- Device Tree -->
          <project name=\"j23g/android_device_samsung_j23g\" path=\"device/samsung/j23g\" remote=\"github\" revision=\"cm-14.1\" />
          
          <!-- MISSING DEPENDENCY FROM LOGS (scx30g2) -->
          <project name=\"j23g/android_device_samsung_scx30g2-common\" path=\"device/samsung/scx30g2-common\" remote=\"github\" />

          <!-- Also keeping scx35 just in case it needs both -->
          <project name=\"j23g/android_device_samsung_scx35-common\" path=\"device/samsung/scx35-common\" remote=\"github\" />

          <!-- Kernel -->
          <project name=\"j23g/android_kernel_samsung_sc8830\" path=\"kernel/samsung/sc8830\" remote=\"github\" />
          
          <!-- Vendor -->
          <project name=\"j23g/android_vendor_samsung_j23g\" path=\"vendor/samsung/j23g\" remote=\"github\" revision=\"cm-14.1\" />
          
          <!-- Hardware -->
          <project name=\"j23g/android_hardware_spreadtrum\" path=\"hardware/spreadtrum\" remote=\"github\" />
          <project name=\"LineageOS/android_hardware_samsung\" path=\"hardware/samsung\" remote=\"github\" revision=\"cm-14.1\" />
        </manifest>' > .repo/local_manifests/roomservice.xml

        # 6. Sync
        repo sync -c -j\$(nproc --all) --force-sync --no-clone-bundle --no-tags

        # 7. Build
        source build/envsetup.sh
        lunch lineage_j23g-userdebug
        mka bacon
        
        # --- INSIDE DOCKER END ---
        "

    - name: 3. Upload Result
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: J200H_ROM
        path: out/target/product/j23g/*.zip
